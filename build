#!/bin/bash

#
# Build script for ovgl - native bionic wrapper with embedded preload
#

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PREFIX="${PREFIX:-/data/data/com.termux/files/usr}"
GLIBC_PREFIX="${GLIBC_PREFIX:-$PREFIX/glibc}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

info() { printf "${GREEN}[INFO]${NC} %s\n" "$1"; }
warn() { printf "${YELLOW}[WARN]${NC} %s\n" "$1"; }
error() { printf "${RED}[ERROR]${NC} %s\n" "$1" >&2; exit 1; }

cd "$SCRIPT_DIR"

# Check for clang
if ! command -v clang >/dev/null 2>&1; then
    error "clang not found. Please install: pkg install clang"
fi

# ============== Step 0: Ensure lib_x86_64 is installed ==============
info "Step 0: Ensuring lib_x86_64 is available under glibc prefix..."

# Default URL can be overridden by setting LIB_X86_64_URL in the environment
LIB_X86_64_URL="${LIB_X86_64_URL:-https://github.com/theonuverse/ovgl/releases/download/v0.0.1/lib_x86_64.tar.gz}"
LIB_X86_64_TAR="lib_x86_64.tar.gz"
TARGET_LIB_DIR="$GLIBC_PREFIX/lib_x86_64"

if [ ! -d "$TARGET_LIB_DIR" ]; then
    info "lib_x86_64 not found at $TARGET_LIB_DIR — downloading from $LIB_X86_64_URL"

    if command -v curl >/dev/null 2>&1; then
        curl -L --fail -o "$LIB_X86_64_TAR" "$LIB_X86_64_URL" || error "Failed to download $LIB_X86_64_URL"
    elif command -v wget >/dev/null 2>&1; then
        wget -O "$LIB_X86_64_TAR" "$LIB_X86_64_URL" || error "Failed to download $LIB_X86_64_URL"
    else
        error "Neither curl nor wget available to download lib_x86_64. Set up manually in $TARGET_LIB_DIR"
    fi

    info "Extracting $LIB_X86_64_TAR to $TARGET_LIB_DIR"
    mkdir -p "$TARGET_LIB_DIR"
    tar -xzf "$LIB_X86_64_TAR" -C "$TARGET_LIB_DIR" || error "Failed to extract $LIB_X86_64_TAR"
    rm -f "$LIB_X86_64_TAR"
    info "Installed lib_x86_64 to $TARGET_LIB_DIR"
else
    info "Found existing $TARGET_LIB_DIR — skipping download"
fi

# Ensure box64 is present in $PREFIX/bin
BOX64_URL="${BOX64_URL:-https://github.com/theonuverse/ovgl/releases/download/v0.0.1/box64}"
BOX64_DEST="$PREFIX/bin/box64"

if [ ! -x "$BOX64_DEST" ]; then
    info "box64 not found at $BOX64_DEST — downloading from $BOX64_URL"
    if command -v curl >/dev/null 2>&1; then
        curl -L --fail -o box64.tmp "$BOX64_URL" || warn "Failed to download box64"
    elif command -v wget >/dev/null 2>&1; then
        wget -O box64.tmp "$BOX64_URL" || warn "Failed to download box64"
    else
        warn "Neither curl nor wget available to download box64; please place box64 in $PREFIX/bin/"
    fi

    if [ -f box64.tmp ]; then
        chmod +x box64.tmp || warn "chmod failed on downloaded box64"
        mkdir -p "$PREFIX/bin"
        mv box64.tmp "$BOX64_DEST" || cp box64.tmp "$BOX64_DEST" || warn "Failed to move box64 to $BOX64_DEST"
        info "Installed box64 to $BOX64_DEST"
    fi
else
    info "Found existing $BOX64_DEST — skipping download"
fi

# ============== Step 1: Build preload library (glibc) ==============

info "Step 1: Building preload library with glibc..."

if [ ! -d "$GLIBC_PREFIX" ]; then
    error "Glibc not found at $GLIBC_PREFIX. Install with: pkg install glibc-runner"
fi

# Clear LD_PRELOAD to avoid interference
# Must compile against glibc since preload is loaded into glibc processes
LD_PRELOAD="" clang \
    --sysroot="$GLIBC_PREFIX" \
    -shared \
    -fPIC \
    -O2 \
    -nostdlib \
    --target=aarch64-linux-gnu \
    -I"$GLIBC_PREFIX/include" \
    -L"$GLIBC_PREFIX/lib" \
    -Wl,--dynamic-linker="$GLIBC_PREFIX/lib/ld-linux-aarch64.so.1" \
    -Wl,-rpath,"$GLIBC_PREFIX/lib" \
    -Wl,--no-as-needed \
    -o libovgl_preload.so \
    ovgl_preload.c \
    -lc -ldl

if [ ! -f "libovgl_preload.so" ]; then
    error "Failed to build libovgl_preload.so"
fi

info "Built libovgl_preload.so ($(stat -c%s libovgl_preload.so) bytes)"

# ============== Step 2: Generate embedded header ==============

info "Step 2: Generating embedded preload header..."

# Generate C array from binary using od (xxd may not be available)
{
    echo "/* Auto-generated - do not edit */"
    echo "/* Embedded preload library data */"
    echo ""
    echo "static const unsigned char preload_so_data[] = {"
    od -An -tx1 -v libovgl_preload.so | sed 's/[0-9a-f]\{2\}/0x&,/g; s/  */ /g; s/^/    /'
    echo "};"
    echo ""
    echo "static const unsigned int preload_so_size = sizeof(preload_so_data);"
} > preload_data.h

info "Generated preload_data.h ($(wc -l < preload_data.h) lines)"

# ============== Step 3: Build main wrapper (bionic) ==============

info "Step 3: Building ovgl wrapper (native bionic)..."

# Build with bionic (default Android toolchain)
clang \
    -O2 \
    -Wall \
    -Wextra \
    -DEMBED_PRELOAD \
    -o ovgl \
    ovgl.c

if [ ! -f "ovgl" ]; then
    error "Failed to build ovgl"
fi

info "Built ovgl ($(stat -c%s ovgl) bytes)"

# ============== Step 4: Verify builds ==============

info "Step 4: Verifying builds..."

echo ""
printf "${BLUE}libovgl_preload.so:${NC}\n"
file libovgl_preload.so
readelf -d libovgl_preload.so 2>/dev/null | grep -E "(NEEDED|RUNPATH|RPATH)" | head -5 || true

echo ""
printf "${BLUE}ovgl:${NC}\n"
file ovgl
readelf -d ovgl 2>/dev/null | grep -E "(NEEDED|INTERP)" | head -5 || true

# ============== Done ==============

echo ""
printf "${GREEN}========================================${NC}\n"
printf "${GREEN}Build complete!${NC}\n"
printf "${GREEN}========================================${NC}\n"
echo ""

# ============== Step 5: Install ==============

info "Step 5: Installing..."

cp ovgl "$PREFIX/bin/"
chmod +x "$PREFIX/bin/ovgl"
info "Installed ovgl to $PREFIX/bin/"

cp libovgl_preload.so "$GLIBC_PREFIX/lib/"
chmod +x "$GLIBC_PREFIX/lib/libovgl_preload.so"
info "Installed libovgl_preload.so to $GLIBC_PREFIX/lib/"

echo ""
printf "${GREEN}========================================${NC}\n"
printf "${GREEN}Installation complete!${NC}\n"
printf "${GREEN}========================================${NC}\n"
echo ""
echo "Usage:"
echo "  ovgl <binary> [args...]"
echo "  ovgl -h                 # Show help"
echo ""